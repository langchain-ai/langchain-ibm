# An action for setting up poetry install with caching.
# Using a custom action since the default action does not
# take poetry install groups into account.
# Action code from:
# https://github.com/actions/setup-python/issues/505#issuecomment-1273013236
name: poetry-install-with-caching
description: Poetry install with support for caching of dependency groups.

inputs:
  python-version:
    description: Python version, supporting MAJOR.MINOR only
    required: true

  poetry-version:
    description: Poetry version
    required: true

  cache-key:
    description: Cache key to use for manual handling of caching
    required: true

  working-directory:
    description: Directory whose poetry.lock file should be cached
    required: true

runs:
  using: composite
  steps:
    - name: Setup Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      id: setup-python
      with:
        python-version: ${{ inputs.python-version }}
        cache: pip

    - name: Cache Poetry wheel
      uses: actions/cache@v4
      id: cache-poetry-wheel
      with:
        path: |
          ~/.cache/pip
        key: poetry-wheel-${{ runner.os }}-py${{ inputs.python-version }}-poetry${{ inputs.poetry-version }}
        restore-keys: |
          poetry-wheel-${{ runner.os }}-py${{ inputs.python-version }}-

    - name: Install Poetry
      shell: bash
      run: |
        "${{ steps.setup-python.outputs.python-path }}" -m pip install --upgrade pip setuptools wheel
        "${{ steps.setup-python.outputs.python-path }}" -m pip install poetry==${{ inputs.poetry-version }}

    - name: Restore pip and poetry cached dependencies
      uses: actions/cache@v4
      env:
        WORKDIR: ${{ inputs.working-directory == '' && '.' || inputs.working-directory }}
      with:
        path: |
          ~/.cache/pypoetry/virtualenvs
          ~/.cache/pypoetry/cache
          ~/.cache/pypoetry/artifacts
          ${{ env.WORKDIR }}/.venv
        key: py-deps-${{ runner.os }}-py${{ inputs.python-version }}-poetry-${{ inputs.poetry-version }}-${{ inputs.cache-key }}-${{ hashFiles(format('{0}/**/poetry.lock', env.WORKDIR)) }}
